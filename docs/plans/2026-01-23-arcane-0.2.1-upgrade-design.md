# Arcane Library 0.2.1 Upgrade Design

## Overview

Upgrade Arcane Design System from 0.1.4 to 0.2.1, adopting the new `arcane-chat` module and migrating to M3 surface naming conventions.

## Changes

### 1. Gradle Configuration

**`shared-ui/build.gradle.kts`:**

```kotlin
// OLD:
implementation("io.github.devmugi.design.arcane:arcane-foundation:0.1.4")
implementation("io.github.devmugi.design.arcane:arcane-components:0.1.4")

// NEW:
implementation("io.github.devmugi.design.arcane:arcane-foundation:0.2.1")
implementation("io.github.devmugi.design.arcane:arcane-components:0.2.1")
implementation("io.github.devmugi.design.arcane:arcane-chat:0.2.1")
```

Source: Maven Local (`~/.m2/repository/io/github/devmugi/design/arcane/`)

### 2. Import Changes

**`ChatScreen.kt`:**

```kotlin
// OLD:
import io.github.devmugi.arcane.design.components.controls.ArcaneAgentChatInput
import io.github.devmugi.arcane.design.components.controls.ArcaneAssistantMessageBlock
import io.github.devmugi.arcane.design.components.controls.ArcaneChatMessageList
import io.github.devmugi.arcane.design.components.controls.ArcaneChatScreenScaffold
import io.github.devmugi.arcane.design.components.controls.ArcaneUserMessageBlock

// NEW:
import io.github.devmugi.arcane.chat.components.input.ArcaneAgentChatInput
import io.github.devmugi.arcane.chat.components.messages.ArcaneAssistantMessageBlock
import io.github.devmugi.arcane.chat.components.messages.ArcaneChatMessageList
import io.github.devmugi.arcane.chat.components.scaffold.ArcaneChatScreenScaffold
import io.github.devmugi.arcane.chat.components.messages.ArcaneUserMessageBlock
import io.github.devmugi.arcane.chat.models.MessageBlock
```

### 3. Surface Naming Migration (M3)

| Old | New |
|-----|-----|
| `ArcaneTheme.colors.surface` | `ArcaneTheme.colors.surfaceContainerLow` |
| `SurfaceVariant.Raised` | `SurfaceVariant.Container` |

**Files affected:**
- `ChatScreen.kt` (lines 87, 177)
- `MessagePopupDialog.kt` (line 50)
- `TopBar.kt` (line 56)
- `ContextChip.kt` (lines 37, 44)
- `ReferenceChip.kt` (lines 38, 58)

### 4. Message Block API Migration

The new `arcane-chat` components use `List<MessageBlock>` instead of plain text.

**User messages:**
```kotlin
// OLD:
ArcaneUserMessageBlock(
    text = message.content,
    backgroundColor = ArcaneTheme.colors.surface,
    textStyle = ArcaneTheme.typography.bodySmall
)

// NEW:
ArcaneUserMessageBlock(
    blocks = listOf(
        MessageBlock.Text(id = "${message.id}-text", content = message.content)
    ),
    backgroundColor = ArcaneTheme.colors.surfaceContainerLow
)
```

**Assistant messages (using Custom block for Markdown):**
```kotlin
// OLD:
ArcaneAssistantMessageBlock(...) {
    Markdown(content = message.content, ...)
}

// NEW:
ArcaneAssistantMessageBlock(
    blocks = listOf(
        MessageBlock.Custom(
            id = "${message.id}-content",
            content = {
                if (isThinking) {
                    Text(text = state.thinkingStatus ?: "...", ...)
                } else {
                    Markdown(content = message.content, ...)
                }
            }
        )
    ),
    ...
)
```

## Files to Modify

| File | Changes |
|------|---------|
| `shared-ui/build.gradle.kts` | Add arcane-chat, bump to 0.2.1 |
| `ChatScreen.kt` | Imports, surface colors, message block API |
| `MessagePopupDialog.kt` | surface → surfaceContainerLow |
| `TopBar.kt` | surface → surfaceContainerLow |
| `ContextChip.kt` | surface → surfaceContainerLow |
| `ReferenceChip.kt` | SurfaceVariant.Raised → Container |

## Verification

```bash
./gradlew :shared-ui:compileKotlinAndroid
```
